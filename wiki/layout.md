## 窗口布局管理数据结构

### 引言

在一个窗口管理器中，布局系统扮演着核心角色。为了高效管理窗口的空间排布，本项目采用了一种结构清晰、修改高效的 `二叉树（Binary Tree）` 结构作为窗口布局的基础数据模型。

### 数据结构设计概览

#### 节点信息设计

```rust
#[derive(Debug, Clone, Copy)]
pub enum Direction {
    Horizontal,
    Vertical,
}

#[derive(Debug, Clone)]
pub enum NodeData {
    Leaf { window: Window },
    Split {
        direction: Direction,
        rec: Rectangle<i32, Logical>,
        left: NodeId,
        right: NodeId,
    }
}
```

- **内部节点（父节点）**：代表一个区域被划分的逻辑，存储以下信息：
  - 分裂方向：水平（Horizontal）或垂直（Vertical）
  - 窗口的起点位置与总大小。
  - 子节点的索引（左子节点与右子节点）

- **叶子节点**：表示一个具体窗口的存在，只存储窗口 ID（或 Surface ID），不再包含其他布局信息。

> 说明：每次添加新窗口时，目标叶子节点会被替换为一个新的父节点，并且规定左子节点处于布局的上方/左侧，其两个子节点分别为原窗口和新窗口的 ID。

### 树操作机制

#### 插入窗口

插入操作会选定一个已有窗口节点，对其进行拆分生成新的父节点，将原窗口与新窗口分配到其左右子节点中。根据当前父节点的布局方向，新的子节点会在水平方向或垂直方向进行排列。

#### 删除窗口

删除窗口时，会通过窗口 ID 定位叶子节点，然后将其父节点下的兄弟节点提升，替换父节点位置，保持布局树的结构完整。

### 自动布局算法

#### 跟随焦点插入/删除窗口

此模式为默认模式，即所有对窗口的布局操作都在当前焦点所在的窗口处执行。

#### 平衡二叉树

此模式实现插入窗口后尽力满足平衡二叉树的要求，即树最短边插入。



### 性能优化：SlotMap 机制

为提升树结构的动态操作性能，本项目引入了 [Rust 的 SlotMap](https://docs.rs/slotmap/) 作为节点存储的底层容器。相比传统引用或 Box 指针，`SlotMap` 具有以下优势：

- **快速访问**：所有节点通过唯一的 Key 标识，可在 O(1) 时间内访问。
- **插入与删除开销小**：不影响其他节点位置，避免指针更新或数据重排。
- **避免悬垂指针问题**：因为节点通过 key 而非裸指针引用，内存安全性更高。

> 每个节点都有一个 `SlotMap::Key` 作为唯一标识，父子节点之间仅存储该 key，实现了高效的索引与修改。
