## Development log

### 2025.3

阅读 `wayland` 协议相关内容，了解底层原理与通信逻辑，学习 `xdg-shell` 核心协议的实现。

阅读 `smithay` 源码与最小实现。

### 2025.3.25

项目正式启动，基于 `smithay-smallvil` 进行基础 `compositor` 的开发，实现了 `client` 与 `compositor` 的简单通信。

### 2025.3.26

实现 `输入设备交互-鼠标与键盘` 与 `compositor` 的交互。

### 2025.3.29

添加 `cursor` 的渲染，实现桌面管理器内部的鼠标图标渲染，支持 `XCursor-default` 与 `wl_surface`。

### 2025.3.31

修复一些已知 `bug`，优化了代码结构，解耦 `winit` 与 `state` 的初始化函数代码。

手写简单的边框渲染 `shader`，配合 `keyboard-focus` 实现了渲染当前焦点所在窗口的边框提示。

### 2025.4.2

添加 `WorkspaceManager` 与 `OutputManager`，实现了简易的工作区切换逻辑。

### 2025.4.3

整理代码结构，优化函数逻辑

### 2025.4.7

实现简易的平铺逻辑，新增 `render` 管理所有渲染请求，优化代码结构。

### 2025.4.8

为 `cursor` 的 `grab` 行为新增 `grab` 指针图标。

### 2025.4.10

实现基于 `平衡二叉树` 平铺排序算法，暂时未实现删除的逻辑。

### 2025.4.12

尝试实现 `layer-shell` 协议。

### 2025.4.13

实现 `layer-shell` 协议，能够支持 `waybar` 的使用，修改了 `input` 模块的代码结构，更加清晰，减少代码重复。

### 2025.4.14

实现 `viewporter` 协议，能够支持 `swww` 的使用，提供更换背景图片的功能。

实现了 `default-layout` 的布局算法，在当前 `focus` 的窗口下插入新窗口。

暂时还未实现删除的算法逻辑。

### 2025.4.16

测试发现删除速度过慢。改用 `slotmap` 建立 `平衡二叉树`，实现查找，插入，删除为 `O(1)` 级别的布局算法。实现动态平铺插入与删除。暂时未支持窗口切换与移动。

### 2025.4.17-25

完成部分文本撰写工作

完成窗口倒置操作

修改了output改变时布局未改变的bug

### 2025.4.26

实现了窗口的动态 resize

修改了多 surface 软件导致焦点丢失的问题 - 绑定根 surface 到 focus

### 2025.4.27 - 5.5

实现tty裸机模式下的图形化界面启动，实现drm设备的最小启动

TODO: 完善drm设备管理，完成渲染额外元素

### 2025.5.6-10

重构代码结构，新增GlobalData作为最大数据集合

TODO: 完善渲染部分代码

### 2025.5.11-12

优化代码结构，寻找实现shader着色器渲染的方法

### 2025.5.13-14

优化tty渲染逻辑，由统一的时钟发起帧渲染事件

### 2025.5.15-17

模仿 niri render的宏定义，实现shader着色器的渲染

### 2025.5.18-20

修复致命 shader 渲染死循环bug，实现 tty 模式下的项目启动

### 2025.5.21-5.23

优化 workspace manager 对于 windows 的管理，优化布局设置过程的管理。
引入 tiled 与 floating 两种 windows 布局情况，为后期平铺式堆叠式多支持做基础。
TODO：完善 resize 部分的代码

### 2025.5.24

完善平铺模式下的grab机制

### 2025.5.25-28

完善平铺模式下的resize机制，修复了 wl_surface 与 wl_subsurface 导致的冲突，grab时需设置 wl_surface 为 focus。

### 2025.5.29-30

添加平铺模式与浮动模式的切换

### 2025.5.31-6.3

记录： 一开始想实现新的布局数据结构，摆脱二叉树的限制，这里记录一下思路和失败的原因。为每一个 window 分配一个 container 容器，container 容器记录其大小位置，并且维护一个 neighbors 表，用来记录上下左右的邻居信息。

失败原因：在 resize 的时候，通知邻居移动太过复杂，需要通知移动方向的邻居，还需要通知移动方向邻居的反方向的邻居，这里虽然成功实现了，但是移动的呈现效果不如人意。

此数据结构得到的移动性能不错，并且由于存储了服务端的 rec，在渲染或者其他操作时可以减少 wayland 通信需求，一定程度上有提升。

### 2025.6.4-6.5

实现 sprial 平铺布局，实现展开与恢复。这里二叉容器树的展开与恢复实现非常优雅，展开只需要实现修改window大小与位置，二叉树的树结构并没有修改，并且使用 split 存储 rec，使得恢复的时候只需要从 root 节点出发，重新刷新一下就可以了，非常优雅。

这里暂时删除了 float 部分的代码，禁用了 grab 和 resize，因为不是目前需要实现的重点。

下一步准备实现手动窗口移动与动画效果。

### 2025.6.6

成功实现动画效果，无需改变任何现有代码，实现如下：

树结构与计算得到的大小位置无需改变，将初始位置与终止位置记录，使用 Animation 包装，记录开始时间，每次渲染的时候进行判断，Animation如果还有内容，则使用当前时间获取到此时的大小与位置（使用不同的插值函数）。

### 2025.6.7

1. 修改了 VBlank 刷新不同步的问题 - 导致出现 tty 模式的撕裂现象，原因是 VBlank 应该是由 drm 主动发起，而不是由我们的 Compositor 控制。

2. 添加了 全局邻接表 数据结构，由于树结构的方向表达太贫瘠，因此实现邻接表，描述某个窗口和相邻的窗口的位置关系，并且基于此实现了键盘控制相邻窗口的交换。

这里对于 animation 的实现仍然有需要解决的问题。

由于窗口的几何信息需要通过cache读取，而cache存放的是当前动画运行的某一帧的内容，因此在动画过程中读取几何信息会导致错误，需要设置服务器位置或者更好的存储方案。

### 2025.6.8-6.10

1. 添加了一些 shader 代码，美化了边框显示，现在具有呼吸灯效果。

2. 完善了 layer-shell 协议的显示，现在 swww 已经可以正确显示壁纸了

3. 完善了 config 的内容，现在允许设置一些自启动项 - 输入法，壁纸等

4. 文本撰写

### 2025.6.11

1. 修复了 popups 和 layer-shell 窗口的相对位置的问题。传输的坐标为鼠标位置相对其 surface 在 output 下的起点。

2. 优化代码结构，整理顺序

### 2025.6.13

撰写初赛文档

### 2025.6.14-19

修复了 tty VBlank 同步问题，修复了 client 使用 dmabuf 导致的不同步撕裂问题。
client 使用 dmabuf 提交 buffer 的时候，不会保证 buffer 已经渲染完毕，需要在 compositor 中对其附加的同步 fence 进行验证，确保帧渲染完毕才进行 drm 交换。

### 2025.6.20-21

1. 添加了 rofi shell 脚本，用于快速启动所需程序

2. 添加 workspace 切换动画，优化了 workspace 的添加与删除

### 2025.6.22-23

完成全屏切换操作

### 2025.6.24-27

完善文本与ppt制作

### 2025.6.28

更新 smithay 版本为 0.7

### 2025.6.29-30

完善优化文本与ppt